<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>ChatOnline</title>
	</head>
	<script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-1.6.4.min.js"></script>
	<body style="background-color: cornflowerblue;">
		<div style="background-color: aquamarine; width: 100%;text-align: center;font-family: tahoma;font-size: 20px;z-index: 9;top: 0px;left: 0px;position: fixed;">
			<div>
				<table style="margin: auto;width: 60%;">
					<tr style="height: 100%;">
						<td>
							服务器地址:
						</td>
						<td align="left">
							<input id="addr" name="addr" type="text" style="height: 100%;width: 80%;" />
						</td>
						<td rowspan="3" style="height: 100%;">
							<button id="conn" name="conn" style="height: 100%;width: 100%;background-color: deepskyblue;border-color: blueviolet;border: 2;">连接</button>
						</td>
						<td rowspan="3" style="height: 100%;">
							<button id="disc" name="disc" style="height: 100%;width: 100%;background-color: orangered;border-color: blueviolet;border: 2;">断开</button>
						</td>
					</tr>
					<tr>
						<td>
							端口号:
						</td>
						<td align="left">
							<input id="port" name="port" type="text" style="height: 100%;width: 80%;" />
						</td>
					</tr>
					<tr>
						<td>
							昵称:
						</td>
						<td align="left">
							<input id="nickname" name="nickname" type="text" style="height: 100%;width: 80%;" />
						</td>
					</tr>
				</table>
			</div>
			<label id="st" name="st" style="background-color: red;">未连接到服务器</label>
		</div>
		<div name="msg" id="msg" style="overflow: auto; position: fixed;top: 150px;left: 15px;right: 15px;bottom: 20%;background-color: azure;"></div>
		<div style="position: absolute;top: 80%;left: 0px;right: 0px;bottom: 0px;background-color: azure;padding: 10px;">
			<table style="height: 100%;width: 100%;" cellpadding="0" cellspacing="0">
				<tr style="height: 100%;">
					<td style="width: 80%;">
						<textarea name="sndtext" id="sndtext" placeholder="输入聊天文本" style="height: 100%;width: 95%;resize: none;"></textarea>
					</td>
					<td style="width: 20%;">
						<input type="button" name="sndbtn" id="sndbtn" value="发送" style="height: 100%; width: 100%;font-size: 50px;" />
					</td>
				</tr>
			</table>
		</div>
	</body>
</html>
<script>
	var wsurl;
	var websocket;
	var nickname;
	
	if (typeof WebSocket == 'undefined')
	{
		alert("浏览器不支持WebSocket!");
		window.close();
	}
	function conn()
	{
		if (websocket && websocket.readyState == 1)
		{
			return ;
		}
		if (!$('#nickname').val())
		{
			alert('昵称不能为空!');
			return ;
		}
		wsurl = 'ws://' + $('#addr').val() + ':' + $('#port').val();
		websocket = new WebSocket(wsurl);
		websocket.onopen = function(event)
		{
			nickname = $('#nickname').val();
			$('#st').text("已连接到服务器");
			$('#st').css('background-color', 'initial');
		}
		websocket.onclose = function(event)
		{
			$('#st').text("未连接到服务器");
			$('#st').css('background-color', 'red');
		}
		websocket.onmessage = function(event)
		{
			var lastmsg = jQuery.parseJSON(event.data);
			$('#msg').append("<table width='100%'><tr><td style='white-space:nowrap;width: 1px;vertical-align:text-top;'>" + lastmsg['n'] + "：</td><td style='word-break: break-all;'>" + lastmsg['t'] + "</td></tr></table>");
			$('#msg')[0].scrollTo(0,$('#msg')[0].scrollHeight);
		}
	}
	function send()
	{
		if (websocket.readyState != 1)
		{
			return ;
		}
		var txt = $('#sndtext').val();
		var pack_msg = {t: txt, n: nickname};

		websocket.send(JSON.stringify(pack_msg));
		$('#sndtext').val('');
	}
	function disconn()
	{
		if (websocket.readyState == 1)
		{
			websocket.close();
			nickname = '';
		}
	}
	$('#sndbtn').bind('click', function(){send()});
	$('#conn').bind('click', function(){conn()});
	$('#disc').bind('click', function(){disconn()});
</script>