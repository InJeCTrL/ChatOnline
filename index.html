<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	</head>
	<link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
	<body style="position: absolute;width: 100%;height: 100%;">
		<div class="modal fade" id="Dlg_Conn" tabindex="-1" role="dialog" aria-labelledby="Dlg_Conn">  
			    <div class="modal-dialog" role="document">  
			        <div class="modal-content">  
			            <div class="modal-header btn-danger">   
			                <h4 class="modal-title" id="myModalLabel">未连接到服务器</h4>  
			            </div>
			            <div class="modal-body">
			                <form class="form-horizontal">
			                	<div class="container">
			                		<div class="row form-group">
			                			<label class="control-label col-lg-1" for="addr">地址</label>
			                			<div class="col-lg-5 col-md-6">
			                				<input class="form-control" type="text" name="addr" id="addr" placeholder="服务器地址（必填）" />
			                			</div>
			                		</div>
			                		<div class="row form-group">
			                			<label class="control-label col-lg-1" for="addr">端口号</label>
			                			<div class="col-lg-5 col-md-6">
			                				<input class="form-control" type="text" name="port" id="port" placeholder="服务器端口号（必填）" />
			                			</div>
			                		</div>
			                		<div class="row form-group">
			                			<label class="control-label col-lg-1" for="nick">昵称</label>
			                			<div class="col-lg-5 col-md-6">
			                				<input class="form-control" type="text" name="nick" id="nick" placeholder="昵称（必填）" />
			                			</div>
			                		</div>
			                	</div>
			                </form>
			            </div>  
			            <div class="modal-footer">    
			                <button id="conn" name="conn" type="button" class="btn btn-primary">连接</button>  
			            </div>  
			        </div>  
			    </div>  
			</div>
		<div class="container" style="height: 100%;">
			<div id="msg" name="msg" class="row" style="padding: 10px;height: 85%;border: groove;border-spacing: 5px;border-width: 5px;border-color: springgreen;overflow-y: scroll;">
			</div>
			<div class="row" style="height: 15%;border: groove;border-color: dodgerblue;">
				<div class="col-xs-12" style="height: 100%;width: 100%;">
                	<div class="input-group" style="height: 100%;width: 100%;">
	                    <textarea id="sndtext" name="sndtext" class="form-control" style="height: 100%;resize: none;"></textarea>
	                    <span class="input-group-btn" style="height: 100%;">
	                        <button id="send" name="send" class="btn btn-primary" type="button" style="height: 100%;">发送!</button>
	                    </span>
	                </div>
	            </div>
			</div>
		</div>
	</body>
	<script>
		$('#send').bind('click', function(){send()});
		$('#conn').bind('click', function(){conn()});
		$('#Dlg_Conn').modal({backdrop: false});
		var wsurl;
		var websocket;
		var nickname;
		
		if (typeof WebSocket == 'undefined')
		{
			alert("浏览器不支持WebSocket!");
			window.close();
		}
		function conn()
		{
			if (websocket && websocket.readyState != 3)
			{
				return ;
			}
			if (!$('#addr').val())
			{
				$('#addr').css('border-color', 'red');
				return ;
			}
			else
			{
				$('#addr').css('border-color', '');
			}
			if (!$('#port').val())
			{
				$('#port').css('border-color', 'red');
				return ;
			}
			else
			{
				$('#port').css('border-color', '');
			}
			if (!$('#nick').val())
			{
				$('#nick').css('border-color', 'red');
				return ;
			}
			else
			{
				$('#nick').css('border-color', '');
			}
			wsurl = 'ws://' + $('#addr').val() + ':' + $('#port').val();
			websocket = new WebSocket(wsurl);
			websocket.onopen = function(event)
			{
				nickname = $('#nick').val();
				$('#Dlg_Conn').modal('hide');
			}
			websocket.onclose = function(event)
			{
				$('#Dlg_Conn').modal({backdrop: false});
			}
			websocket.onmessage = function(event)
			{
				var lastmsg = jQuery.parseJSON(event.data);
				$('#msg').append("<div>" + lastmsg['n'] + " 发言</div><div style='border-bottom-right-radius: 20px;border: solid;padding: 10px;border-color: darksalmon;margin-bottom: 10px;word-break: break-all;display:inline-block;'>" + lastmsg['t'] + "</div>");
				$('#msg')[0].scrollTo(0, $('#msg')[0].scrollHeight);
			}
		}
		function send()
		{
			if (websocket.readyState != 1)
			{
				return ;
			}
			var txt = $('#sndtext').val();
			var pack_msg = {t: txt, n: nickname};
			websocket.send(JSON.stringify(pack_msg));
			$('#sndtext').val('');
		}
	</script>
</html>
